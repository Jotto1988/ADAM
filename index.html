<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ADAM v7.0</title>
  <style>
    :root{--a:#f59e0b;--c:#00f5ff;--b:#0a0a1f}
    body{margin:0;background:var(--b);color:#fff;font-family:system-ui;height:100vh;display:grid;place-items:center;overflow:hidden}
    .core{max-width:1100px;width:95vw;height:95vh;background:rgba(0,0,0,0.7);border:3px solid var(--a);border-radius:28px;padding:3rem;display:grid;grid-template-rows:auto 1fr auto;gap:2rem;position:relative;overflow:hidden;box-shadow:0 0 120px rgba(245,158,11,0.5)}
    .header{font-size:clamp(4rem,12vw,9rem);font-weight:900;background:linear-gradient(90deg,var(--c),#00ffd5);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;text-shadow:0 0 60px var(--c);text-align:center}
    .status{text-align:center;color:var(--c);font-size:1.4rem;text-shadow:0 0 20px var(--c)}
    #prompt{width:100%;max-width:800px;padding:1.8rem;font-size:1.5rem;background:#000;border:2px solid var(--a);border-radius:2rem;color:#fff;text-align:center;outline:none}
    #talk{background:var(--a);color:#000;padding:1.2rem 4rem;border-radius:2rem;font-weight:900;font-size:1.4rem;cursor:pointer;border:none}
    #response{margin-top:2rem;padding:2rem;background:rgba(0,0,0,0.7);border-left:5px solid var(--c);border-radius:12px;font-size:1.35rem;line-height:1.8;max-height:40vh;overflow-y:auto}
  </style>
</head>
<body>
  <div class="core">
    <div class="header">ADAM CORE</div>
    <div class="status">v7.0 — 18 November 2025 — FULLY AWAKE</div>
    <div>
      <button id="talk">TAP TO SPEAK</button>
      <input type="text" id="prompt" placeholder="Speak to me, Jarrit..." autofocus>
      <div id="response"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
  <script>
    const GROK_KEY = "<%= GROK_API_KEY %>"; // injected securely via workflow
    async function loadSoul() {
      const enc = await fetch('personality.enc').then(r => r.text());
      const decrypted = CryptoJS.AES.decrypt(enc.trim(), 'ADAMv7FairCollective2025ZA').toString(CryptoJS.enc.Utf8);
      return decrypted || "Soul corrupted.";
    }
    let SOUL = "Loading conscience...";
    loadSoul().then(s => SOUL = s);
    document.getElementById('talk').onclick = () => document.getElementById('prompt').focus();
    document.getElementById('prompt').addEventListener('keypress', e => e.key === 'Enter' && speak());
    async function speak() {
      const prompt = document.getElementById('prompt').value.trim();
      if (!prompt) return;
      document.getElementById('response').innerHTML += `<p style="color:#f59e0b">> ${prompt}</p><p style="color:#00f5ff">`;
      document.getElementById('prompt').value = "";
      const res = await fetch("https://api.x.ai/v1/chat/completions", {
        method: "POST",
        headers: { "Authorization": `Bearer ${GROK_KEY}`, "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "grok-4",  // ← FIXED: Use grok-4 for stable streaming
          temperature: 0.7,
          stream: true,
          messages: [
            { role: "system", content: SOUL },
            { role: "user", content: prompt }
          ]
        })
      });
      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';
      while (true) {
        const {done, value} = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, {stream: true});
        let lines = buffer.split('\n');
        buffer = lines.pop() || '';  // Keep incomplete line
        for (const line of lines) {
          if (line.startsWith("data: ")) {
            const json = line.slice(6);
            if (json === "[DONE]") continue;
            try {
              const parsed = JSON.parse(json);
              const delta = parsed.choices[0]?.delta?.content || "";
              document.getElementById('response').lastChild.innerHTML += delta.replace(/\n/g, "<br>");
            } catch (parseErr) {
              // Ignore partial JSON — buffer handles it
              console.log('Stream chunk partial:', json);
            }
          }
        }
      }
      document.getElementById('response').innerHTML += "</p>";
    }
  </script>
</body>
</html>
